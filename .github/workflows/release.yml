name: Publication ğŸ“¦

on:
  release:
    types: [published]

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.release.tag_name }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Verify tag matches package.json
        run: |
          TAG_NAME="${{ github.event.release.tag_name }}"
          TAG_VERSION="${TAG_NAME#v}"
          PKG_VERSION=$(jq -r .version package.json)

          if [ "$TAG_VERSION" != "$PKG_VERSION" ]; then
            echo "Error: íƒœê·¸ ë²„ì „ê³¼ package.json ë²„ì „ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
            echo "tag version: ${TAG_VERSION}"
            echo "package.json version: ${PKG_VERSION}"
            exit 1
          fi
          echo "âœ… ë²„ì „ ì¼ì¹˜ í™•ì¸: ${TAG_VERSION}"

      - name: Build package
        run: |
          bun run prepare
          bun run build:lib

      - name: Publish to npm
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > .npmrc

          bun publish
          echo "npm ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
